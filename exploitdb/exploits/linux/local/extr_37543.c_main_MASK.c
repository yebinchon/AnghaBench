#define NULL ((void*)0)
typedef unsigned long size_t;  // Customize by platform.
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;  // Either arithmetic or pointer type.
/* By default, we understand bool (as a convenience). */
typedef int bool;
#define false 0
#define true 1

/* Forward declarations */
typedef  struct TYPE_2__   TYPE_1__ ;

/* Type definitions */
struct TYPE_2__ {int /*<<< orphan*/  s_addr; } ;
struct sockaddr_in {int /*<<< orphan*/  sin_port; TYPE_1__ sin_addr; int /*<<< orphan*/  sin_family; } ;
struct sockaddr {int dummy; } ;
struct msghdr {int msg_namelen; int msg_iovlen; scalar_t__ msg_flags; scalar_t__ msg_controllen; scalar_t__ msg_control; struct iovec* msg_iov; struct sockaddr_in* msg_name; } ;
struct iovec {char* iov_base; int iov_len; } ;
typedef  int /*<<< orphan*/  serverAddr ;
typedef  int /*<<< orphan*/  fromAddr ;

/* Variables and functions */
 int /*<<< orphan*/  AF_INET ; 
 int /*<<< orphan*/  AF_RDS ; 
 int /*<<< orphan*/  SOCK_SEQPACKET ; 
 scalar_t__ FUNC0 (int,struct sockaddr*,int) ; 
 int /*<<< orphan*/  FUNC1 (int) ; 
 int /*<<< orphan*/  FUNC2 (int) ; 
 int /*<<< orphan*/  FUNC3 (int) ; 
 int /*<<< orphan*/  FUNC4 (char*) ; 
 int /*<<< orphan*/  FUNC5 (struct sockaddr_in*,int /*<<< orphan*/ ,int) ; 
 int /*<<< orphan*/  FUNC6 (char*) ; 
 int /*<<< orphan*/  FUNC7 (char*,...) ; 
 int FUNC8 (int,struct msghdr*,int /*<<< orphan*/ ) ; 
 int FUNC9 (int,struct msghdr*,int /*<<< orphan*/ ) ; 
 int FUNC10 (int /*<<< orphan*/ ,int /*<<< orphan*/ ,int /*<<< orphan*/ ) ; 
 int /*<<< orphan*/  FUNC11 (char*,char*) ; 

int FUNC12(void)
{
struct sockaddr_in fromAddr;
int sock_fd;
struct sockaddr_in serverAddr;
unsigned int addrLen;
char recvBuffer[128];
struct msghdr msg;
struct iovec iov;

sock_fd = FUNC10(AF_RDS, SOCK_SEQPACKET, 0);
if(sock_fd < 0) {
FUNC6("create socket error\n");
FUNC2(0);
}

FUNC5(&serverAddr, 0, sizeof(serverAddr));
serverAddr.sin_family = AF_INET;
serverAddr.sin_addr.s_addr = FUNC4("127.0.0.1");
serverAddr.sin_port = FUNC3(4000);
if (FUNC0(sock_fd, (struct sockaddr*)&serverAddr, sizeof(serverAddr)) < 0) {
FUNC6("bind error\n");
FUNC1(sock_fd);
FUNC2(1);
}

FUNC7("server is waiting to receive data...\n");
msg.msg_name = &fromAddr;

/*
 * I add 16 to sizeof(fromAddr), ie 32,
 * and pay attention to the definition of fromAddr,
 * recvmsg() will overwrite sock_fd,
 * since kernel will copy 32 bytes to userspace.
 *
 * If you just use sizeof(fromAddr), it works fine.
 * */
msg.msg_namelen = sizeof(fromAddr) + 16;
/* msg.msg_namelen = sizeof(fromAddr); */
msg.msg_iov = &iov;
msg.msg_iovlen = 1;
msg.msg_iov->iov_base = recvBuffer;
msg.msg_iov->iov_len = 128;
msg.msg_control = 0;
msg.msg_controllen = 0;
msg.msg_flags = 0;

while (1) {
FUNC7("old socket fd=%d\n", sock_fd);
if (FUNC8(sock_fd, &msg, 0) == -1) {
FUNC6("recvmsg() error\n");
FUNC1(sock_fd);
FUNC2(1);
}
FUNC7("server received data from client:%s\n", recvBuffer);
FUNC7("msg.msg_namelen=%d\n", msg.msg_namelen);
FUNC7("new socket fd=%d\n", sock_fd);
FUNC11(recvBuffer, "--data from server");
if (FUNC9(sock_fd, &msg, 0) == -1) {
FUNC6("sendmsg()\n");
FUNC1(sock_fd);
FUNC2(1);
}
}

FUNC1(sock_fd);
return 0;
}