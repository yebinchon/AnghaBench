#define NULL ((void*)0)
typedef unsigned long size_t;  // Customize by platform.
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;  // Either arithmetic or pointer type.
/* By default, we understand bool (as a convenience). */
typedef int bool;
#define false 0
#define true 1

/* Forward declarations */
typedef  struct TYPE_4__   TYPE_2__ ;
typedef  struct TYPE_3__   TYPE_1__ ;

/* Type definitions */
struct TYPE_4__ {int tv_sec; scalar_t__ tv_usec; } ;
struct TYPE_3__ {int tv_sec; scalar_t__ tv_usec; } ;
struct itimerval {TYPE_2__ it_value; TYPE_1__ it_interval; } ;
typedef  int /*<<< orphan*/  Connect ;

/* Variables and functions */
 char* End ; 
 int /*<<< orphan*/  ITIMER_REAL ; 
 int MAX_PAYLOAD_LEN ; 
 char* OK ; 
#define  PING_DESCR 131 
#define  PONG_DESCR 130 
#define  PUSH_DESCR 129 
#define  QUERY_DESCR 128 
 int /*<<< orphan*/  SIGALRM ; 
 scalar_t__ SIG_ERR ; 
 int /*<<< orphan*/  FUNC0 (int) ; 
 int /*<<< orphan*/  FUNC1 (int,unsigned int) ; 
 int /*<<< orphan*/  FUNC2 (int) ; 
 int /*<<< orphan*/ * FUNC3 (char*,char*) ; 
 int /*<<< orphan*/  FUNC4 (int /*<<< orphan*/ *,char*,...) ; 
 int /*<<< orphan*/ * out_stream ; 
 int /*<<< orphan*/  FUNC5 (int,unsigned int,char*) ; 
 int /*<<< orphan*/  FUNC6 (char*) ; 
 int FUNC7 (int,char*,int) ; 
 int /*<<< orphan*/  FUNC8 (int,unsigned char*,unsigned int*,char*) ; 
 int /*<<< orphan*/  FUNC9 (int) ; 
 int /*<<< orphan*/  FUNC10 (int,char*,char*) ; 
 int FUNC11 (int /*<<< orphan*/ ,struct itimerval*,int) ; 
 scalar_t__ FUNC12 (int /*<<< orphan*/ ,int /*<<< orphan*/ ) ; 
 int /*<<< orphan*/ * stderr ; 
 unsigned int FUNC13 (char*) ; 
 scalar_t__ FUNC14 (char*,char*,unsigned int) ; 
 int /*<<< orphan*/  timer_send_ping ; 
 int /*<<< orphan*/  FUNC15 (int,char*,unsigned int) ; 

int
FUNC16(int argc, char * argv[]){
unsigned int seed;
  int net_in_fd = 0;
  char *msg;
  char criteria[4096];
  char c;  
  char buf[1024];
  int num_read;
  unsigned char payload_descr;
  unsigned payload_len;
  char payload[MAX_PAYLOAD_LEN];
  char descr_id[16];
  int queryhit_sent = 0;
  int i;
  
  int net_out_fd = 1;
  struct itimerval itv;


  /* set up the local output stream */
  if((out_stream = FUNC3("/dev/tty", "w")) == NULL){
    FUNC6("Can't open /dev/tty");
    /* let's use stderr instead */
    out_stream = stderr;
  }
  
  if(FUNC12(SIGALRM, timer_send_ping) == SIG_ERR){
    FUNC4(out_stream, "Couldn't set the signal handler");
    FUNC2(1);
  }
  
  itv.it_interval.tv_sec = 5;
  itv.it_interval.tv_usec = 0;  
  itv.it_value.tv_sec = 5;
  itv.it_value.tv_usec = 0;
  
  /* that stupid client closes the connection after 15 secs */
  if(FUNC11(ITIMER_REAL, &itv, 0x00) == -1){
    FUNC4(out_stream, "Couldn't set the signal handler");
    FUNC2(1);
  }

  // make a connection with the client  

  // read the begining     
  num_read = FUNC7(net_in_fd, buf, sizeof(Connect));
  if(num_read != sizeof(Connect)){
    FUNC4(out_stream, "Can't read \"Connect\" from the net\n");
    FUNC2(1);
  }
  
  // maybe later compare what's read with "Connect":    if(strncpy

  // now read read everything until the final "\n\n"
  num_read = FUNC7(net_in_fd, buf, FUNC13(End));
  if(num_read != FUNC13(End)){
    FUNC4(out_stream, "Connection closed before double \\n\n");
    FUNC2(1);       
  }
  
  while(FUNC14(buf, End, FUNC13(End)) != 0){
    FUNC4(out_stream, "%s\n", buf);

    // shift the buffer by one

    for(i = 0; i < FUNC13(End) - 1; i++){
      buf[i] = buf[i+1];
    }
    num_read = FUNC7(net_in_fd, &buf[FUNC13(End) - 1], 1);
    if(num_read != 1){
      FUNC4(out_stream, "Connection closed before double \\n\n");
      FUNC2(1);
    }
  }


  // let's connect
  FUNC15(net_out_fd, OK, FUNC13(OK));
  FUNC4(out_stream, "Connected (hopefully)\n");

  /* Now the peer will send the OK message, read it */  
  FUNC1(net_in_fd, FUNC13("GNUTELLA/0.6 200 OK\r\n\r\n"));


  while(1){
    if(!FUNC8(net_in_fd,
		    &payload_descr,
		    &payload_len,
		    descr_id)) break;
    FUNC0(payload_len <= MAX_PAYLOAD_LEN);
    switch(payload_descr){
    case PING_DESCR:
      /* the payload lenght should be zero */
      FUNC4(out_stream, "Received a Ping message\n");
      if(payload_len != 0){
	FUNC4(out_stream, "Payload for Ping > 0 !\n");
      }
      FUNC4(out_stream, "Sending a Pong message\n");
      FUNC9(net_out_fd);      
      break;
    case PONG_DESCR:
    /* show the payload */
      FUNC4(out_stream, "Received a Pong message\n");
      if(!FUNC1(net_in_fd, payload_len)) break;
      break;      
    case QUERY_DESCR:
      /* parse the payload */
      FUNC4(out_stream, "Received a Query message\n");
      if(!FUNC5(net_in_fd, payload_len, criteria)) break;
      if(!queryhit_sent){
	queryhit_sent = 1;
	FUNC4(out_stream, "Sending a QueryHit message\n");
	FUNC10(net_out_fd, criteria, descr_id);
	FUNC4(out_stream, "QueryHit sent\n");
      } else {
	FUNC4(out_stream, "NOT sending a QueryHit message\n");		
      }
      break;
    case PUSH_DESCR:
      /* show the payload */
      FUNC4(out_stream, "Received a Push message\n");
      if(!FUNC1(net_in_fd, payload_len)) break;
      break;      
    }
  }
}